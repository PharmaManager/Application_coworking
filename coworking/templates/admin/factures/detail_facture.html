{% extends 'admin/base_admin.html' %}

{% block title %}Détail Facture {{ facture.numero }} - Administration{% endblock %}

{% block page_title %}Détail de la Facture {{ facture.numero }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard_admin' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'liste_factures_admin' %}">Factures</a></li>
        <li class="breadcrumb-item active">{{ facture.numero }}</li>
    </ol>
</nav>
{% endblock %}

{% block page_actions %}
<div class="btn-group me-2">
    <a href="{% url 'liste_factures_admin' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Retour à la liste
    </a>
    <a href="#" class="btn btn-sm btn-outline-primary" onclick="window.print()">
        <i class="bi bi-printer"></i> Imprimer
    </a>
    <a href="#" class="btn btn-sm btn-outline-success" id="btn-download-pdf">
        <i class="bi bi-file-earmark-pdf"></i> Télécharger PDF
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Informations principales -->
        <div class="col-md-8">
            <div class="card mb-4" id="facture-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-receipt me-2"></i>Facture {{ facture.numero }}
                    </h5>
                    <span class="badge badge-status" id="statut-badge">{{ facture.get_statut_display }}</span>
                </div>
                <div class="card-body">
                    <!-- Informations du membre -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Informations du membre</h6>
                            <div class="membre-info">
                                <p class="mb-1"><strong>Nom :</strong> {{ facture.membre.first_name }} {{ facture.membre.last_name }}</p>
                                <p class="mb-1"><strong>Email :</strong> {{ facture.membre.email }}</p>
                                {% if facture.membre.profilmembre.telephone %}
                                <p class="mb-1"><strong>Téléphone :</strong> {{ facture.membre.profilmembre.telephone }}</p>
                                {% endif %}
                                {% if facture.membre.profilmembre.entreprise %}
                                <p class="mb-1"><strong>Entreprise :</strong> {{ facture.membre.profilmembre.entreprise }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Détails de la facture</h6>
                            <div class="facture-details">
                                <p class="mb-1"><strong>Date de création :</strong> {{ facture.date_creation|date:"d/m/Y H:i" }}</p>
                                <p class="mb-1"><strong>Date d'échéance :</strong> {{ facture.date_echeance|date:"d/m/Y" }}</p>
                                <p class="mb-1"><strong>Montant total :</strong> <span class="montant-total">{{ facture.montant_total }} DH</span></p>
                                {% if facture.reservation %}
                                <p class="mb-1"><strong>Réservation :</strong> 
                                    <a href="{% url 'detail_reservation_admin' facture.reservation.id %}" class="text-decoration-none">
                                        {{ facture.reservation.espace.nom }} - {{ facture.reservation.date_debut|date:"d/m/Y" }}
                                    </a>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Détails de la réservation si applicable -->
                    {% if facture.reservation %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">Détails de la réservation</h6>
                            <div class="reservation-details border rounded p-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <p class="mb-1"><strong>Espace :</strong> {{ facture.reservation.espace.nom }}</p>
                                        <p class="mb-1"><strong>Type :</strong> {{ facture.reservation.espace.type_espace.nom }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="mb-1"><strong>Date de début :</strong> {{ facture.reservation.date_debut|date:"d/m/Y H:i" }}</p>
                                        <p class="mb-1"><strong>Date de fin :</strong> {{ facture.reservation.date_fin|date:"d/m/Y H:i" }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="mb-1"><strong>Durée :</strong> <span id="duree-reservation"></span></p>
                                        <p class="mb-1"><strong>Prix horaire :</strong> {{ facture.reservation.espace.prix_heure }} DH</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Actions et historique -->
        <div class="col-md-4">
            <!-- Actions rapides -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-tools me-2"></i>Actions
                    </h6>
                </div>
                <div class="card-body">
                    {% if facture.statut == 'en_attente' %}
                    <button class="btn btn-success btn-sm w-100 mb-2" id="btn-marquer-payee">
                        <i class="bi bi-check-circle"></i> Marquer comme payée
                    </button>
                    {% endif %}
                    
                    {% if facture.statut != 'annulee' %}
                    <button class="btn btn-danger btn-sm w-100 mb-2" id="btn-annuler-facture">
                        <i class="bi bi-x-circle"></i> Annuler la facture
                    </button>
                    {% endif %}
                    
                    <button class="btn btn-warning btn-sm w-100 mb-2" id="btn-envoyer-rappel">
                        <i class="bi bi-bell"></i> Envoyer un rappel
                    </button>
                    
                    <button class="btn btn-info btn-sm w-100" id="btn-modifier-facture">
                        <i class="bi bi-pencil"></i> Modifier la facture
                    </button>
                </div>
            </div>

            <!-- Historique des paiements -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>Historique des paiements
                    </h6>
                </div>
                <div class="card-body">
                    <div class="historique-paiements" id="historique-paiements">
                        {% for paiement in facture.historiquepaiement_set.all %}
                        <div class="historique-item mb-2 p-2 border-start">
                            <small class="text-muted">{{ paiement.date_paiement|date:"d/m/Y H:i" }}</small>
                            <p class="mb-0">Paiement de {{ paiement.montant }} DH</p>
                        </div>
                        {% empty %}
                        <p class="text-muted mb-0">Aucun paiement enregistré</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmation-message">Êtes-vous sûr de vouloir effectuer cette action ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirm-action">Confirmer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculer la durée de réservation si applicable
    {% if facture.reservation %}
    const dateDebut = new Date('{{ facture.reservation.date_debut|date:"c" }}');
    const dateFin = new Date('{{ facture.reservation.date_fin|date:"c" }}');
    const dureeHeures = Math.round((dateFin - dateDebut) / (1000 * 60 * 60));
    document.getElementById('duree-reservation').textContent = dureeHeures + ' heure(s)';
    {% endif %}

    // Gestion du statut avec couleurs
    const statutBadge = document.getElementById('statut-badge');
    const statut = '{{ facture.statut }}';
    
    switch(statut) {
        case 'payee':
            statutBadge.className = 'badge bg-success';
            break;
        case 'en_attente':
            statutBadge.className = 'badge bg-warning text-dark';
            break;
        case 'en_retard':
            statutBadge.className = 'badge bg-danger';
            break;
        case 'annulee':
            statutBadge.className = 'badge bg-secondary';
            break;
    }

    // Actions sur les boutons
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    let actionCallback = null;

    // Marquer comme payée
    const btnPayee = document.getElementById('btn-marquer-payee');
    if (btnPayee) {
        btnPayee.addEventListener('click', function() {
            document.getElementById('confirmation-message').textContent = 
                'Marquer cette facture comme payée ?';
            actionCallback = () => {
                // Ici vous pouvez ajouter l'appel AJAX pour marquer comme payée
                console.log('Facture marquée comme payée');
                location.reload();
            };
            confirmModal.show();
        });
    }

    // Annuler facture
    const btnAnnuler = document.getElementById('btn-annuler-facture');
    if (btnAnnuler) {
        btnAnnuler.addEventListener('click', function() {
            document.getElementById('confirmation-message').textContent = 
                'Annuler définitivement cette facture ?';
            actionCallback = () => {
                // Ici vous pouvez ajouter l'appel AJAX pour annuler
                console.log('Facture annulée');
                location.reload();
            };
            confirmModal.show();
        });
    }

    // Envoyer rappel
    const btnRappel = document.getElementById('btn-envoyer-rappel');
    if (btnRappel) {
        btnRappel.addEventListener('click', function() {
            document.getElementById('confirmation-message').textContent = 
                'Envoyer un rappel de paiement au membre ?';
            actionCallback = () => {
                // Ici vous pouvez ajouter l'appel AJAX pour envoyer le rappel
                console.log('Rappel envoyé');
            };
            confirmModal.show();
        });
    }

    // Confirmation d'action
    document.getElementById('confirm-action').addEventListener('click', function() {
        if (actionCallback) {
            actionCallback();
            confirmModal.hide();
        }
    });
});
</script>
{% endblock %}