{% extends 'admin/base_admin.html' %}

{% block title %}Envoyer une notification{% endblock %}

{% block content %}
<div class="container-fluid" id="notificationFormContainer">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4" id="pageHeader">
                <h1 class="h2 mb-0">Envoyer une notification</h1>
                <nav aria-label="breadcrumb" id="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="{% url 'dashboard_admin' %}" class="text-decoration-none">Dashboard</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Notifications</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-sm" id="formCard">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell me-2"></i>
                        Nouvelle notification
                    </h5>
                </div>
                
                <div class="card-body" id="formWrapper">
                    <form method="post" class="needs-validation" id="notificationForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Section informations de base -->
                        <div class="mb-4" id="basicInfoSection">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Informations de base
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3" id="titreGroup">
                                        <label for="{{ form.titre.id_for_label }}" class="form-label required">
                                            {{ form.titre.label }}
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" 
                                               class="form-control {% if form.titre.errors %}is-invalid{% endif %}" 
                                               id="{{ form.titre.id_for_label }}"
                                               name="{{ form.titre.name }}"
                                               value="{{ form.titre.value|default:'' }}"
                                               maxlength="100"
                                               required>
                                        {% if form.titre.errors %}
                                            <div class="invalid-feedback" id="titreErrors">
                                                {{ form.titre.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3" id="typeGroup">
                                        <label for="{{ form.type_notification.id_for_label }}" class="form-label required">
                                            {{ form.type_notification.label }}
                                            <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select {% if form.type_notification.errors %}is-invalid{% endif %}"
                                                id="{{ form.type_notification.id_for_label }}"
                                                name="{{ form.type_notification.name }}"
                                                required>
                                            <option value="">Choisir un type...</option>
                                            {% for choice in form.type_notification.field.choices %}
                                                <option value="{{ choice.0 }}" {% if form.type_notification.value == choice.0 %}selected{% endif %}>
                                                    {{ choice.1 }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        {% if form.type_notification.errors %}
                                            <div class="invalid-feedback" id="typeErrors">
                                                {{ form.type_notification.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3" id="messageGroup">
                                <label for="{{ form.message.id_for_label }}" class="form-label required">
                                    {{ form.message.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control {% if form.message.errors %}is-invalid{% endif %}"
                                          id="{{ form.message.id_for_label }}"
                                          name="{{ form.message.name }}"
                                          rows="4"
                                          maxlength="500"
                                          required>{{ form.message.value|default:'' }}</textarea>
                                <div class="form-text">
                                    <span id="messageCounter">0/500 caractères</span>
                                </div>
                                {% if form.message.errors %}
                                    <div class="invalid-feedback" id="messageErrors">
                                        {{ form.message.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Section destinataires -->
                        <div class="mb-4" id="destinatairesSection">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-users me-2"></i>
                                Destinataires
                            </h6>
                            
                            <div class="alert alert-info" id="destinatairesInfo">
                                <i class="fas fa-info-circle me-2"></i>
                                Si aucun destinataire n'est sélectionné, la notification sera envoyée à tous les membres.
                            </div>
                            
                            <div class="mb-3" id="destinatairesGroup">
                                <label class="form-label">{{ form.destinataires_multiples.label }}</label>
                                
                                <div class="btn-toolbar mb-3" id="destinatairesControls">
                                    <div class="btn-group btn-group-sm me-2" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="selectAllBtn">
                                            <i class="fas fa-check-square me-1"></i>
                                            Tout sélectionner
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="deselectAllBtn">
                                            <i class="fas fa-square me-1"></i>
                                            Tout désélectionner
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="toggleListBtn">
                                        <i class="fas fa-eye-slash me-1"></i>
                                        Masquer la liste
                                    </button>
                                </div>
                                
                                <div class="card" id="destinatairesList">
                                    <div class="card-header bg-light">
                                        <div class="input-group input-group-sm" id="searchBox">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="searchInput" 
                                                   placeholder="Rechercher un utilisateur...">
                                        </div>
                                    </div>
                                    
                                    <div class="card-body" style="max-height: 300px; overflow-y: auto;" id="checkboxList">
                                        {% for choice in form.destinataires_multiples %}
                                            <div class="form-check user-item">
                                                {{ choice.tag }}
                                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                    {{ choice.choice_label }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                {% if form.destinataires_multiples.errors %}
                                    <div class="text-danger mt-2" id="destinatairesErrors">
                                        <small>{{ form.destinataires_multiples.errors.0 }}</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2" id="formActions">
                            <a href="{% url 'dashboard_admin' %}" class="btn btn-secondary" id="cancelBtn">
                                <i class="fas fa-times me-1"></i>
                                Annuler
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-paper-plane me-1"></i>
                                Envoyer la notification
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" id="modalContent">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title" id="confirmModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirmer l'envoi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="modalCloseBtn"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <p id="confirmMessage">Êtes-vous sûr de vouloir envoyer cette notification ?</p>
                <div class="alert alert-light" id="recipientsCount">
                    <i class="fas fa-users me-2"></i>
                    <span id="countText"></span>
                </div>
            </div>
            <div class="modal-footer" id="modalActions">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelSendBtn">
                    <i class="fas fa-times me-1"></i>
                    Annuler
                </button>
                <button type="button" class="btn btn-primary" id="confirmSendBtn">
                    <i class="fas fa-check me-1"></i>
                    Confirmer l'envoi
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Éléments du DOM
    const form = document.getElementById('notificationForm');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const toggleListBtn = document.getElementById('toggleListBtn');
    const destinatairesList = document.getElementById('destinatairesList');
    const searchInput = document.getElementById('searchInput');
    const checkboxes = document.querySelectorAll('#checkboxList input[type="checkbox"]');
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const submitBtn = document.getElementById('submitBtn');
    const confirmSendBtn = document.getElementById('confirmSendBtn');
    const messageField = document.getElementById('{{ form.message.id_for_label }}');
    const messageCounter = document.getElementById('messageCounter');

    // Compteur de caractères pour le message
    function updateMessageCounter() {
        const charCount = messageField.value.length;
        const maxLength = 500;
        messageCounter.textContent = `${charCount}/${maxLength} caractères`;

        if (charCount > maxLength) {
            messageCounter.classList.add('text-danger');
        } else {
            messageCounter.classList.remove('text-danger');
        }
    }

    messageField?.addEventListener('input', updateMessageCounter);
    updateMessageCounter();

    // Tout sélectionner / désélectionner
    selectAllBtn?.addEventListener('click', function() {
        checkboxes.forEach(cb => {
            const userItem = cb.closest('.user-item');
            if (userItem && userItem.style.display !== 'none') cb.checked = true;
        });
        updateRecipientCount();
    });

    deselectAllBtn?.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateRecipientCount();
    });

    // Toggle liste des destinataires
    let listVisible = true;
    toggleListBtn?.addEventListener('click', function() {
        destinatairesList.style.display = listVisible ? 'none' : 'block';
        toggleListBtn.innerHTML = listVisible 
            ? '<i class="fas fa-eye me-1"></i>Afficher la liste'
            : '<i class="fas fa-eye-slash me-1"></i>Masquer la liste';
        listVisible = !listVisible;
    });

    // Recherche dans la liste
    searchInput?.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll('#checkboxList .user-item').forEach(item => {
            const label = item.querySelector('label');
            const text = label ? label.textContent.toLowerCase() : '';
            item.style.display = text.includes(term) ? 'block' : 'none';
        });
    });

    // Mise à jour compteur destinataires
    function updateRecipientCount() {
        const visible = Array.from(checkboxes).filter(cb => cb.closest('.user-item').style.display !== 'none');
        const selected = visible.filter(cb => cb.checked).length;
        const totalCount = checkboxes.length;
        const countText = document.getElementById('countText');
        countText.textContent = selected === 0 
            ? `Tous les membres recevront la notification (${totalCount} membres)` 
            : `${selected} destinataire(s) sélectionné(s)`;
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateRecipientCount);
        cb.classList.add('form-check-input');
    });

    updateRecipientCount();

    // === Gestion du submit et modal ===
    let allowSubmit = false;

    form?.addEventListener('submit', function(e) {
        if (!allowSubmit) {
            e.preventDefault();

            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            updateRecipientCount();
            confirmModal.show();
        }
    });

    confirmSendBtn?.addEventListener('click', function() {
        allowSubmit = true;
        confirmModal.hide();

        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Traitement...';
        submitBtn.disabled = true;

        // Soumission réelle sans repasser par le listener
        HTMLFormElement.prototype.submit.call(form);
    });

    // Validation temps réel
    form?.addEventListener('input', function(e) {
        if (e.target.matches('input, textarea, select')) {
            if (e.target.checkValidity()) {
                e.target.classList.remove('is-invalid');
                e.target.classList.add('is-valid');
            } else {
                e.target.classList.remove('is-valid');
                e.target.classList.add('is-invalid');
            }
        }
    });

    // Réinitialiser le bouton si modal fermé sans confirmer
    document.getElementById('confirmModal')?.addEventListener('hidden.bs.modal', function() {
        if (!allowSubmit) {
            submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Envoyer la notification';
            submitBtn.disabled = false;
        }
    });
});
</script>

{% endblock %}